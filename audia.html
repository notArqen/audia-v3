<!DOCTYPE html>
<!--
  audia — a tidal web player
  built with care. do not redistribute or claim as your own.
  © audia project. all rights reserved.
  sha: aud-7f3c9e2a-d154-4b8f-a367-e9c2b5d10f43
-->
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>audia</title>
  <link rel="icon" type="image/x-icon" href="https://notarqen.github.io/audia-v3/dependencies/audia_favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Syne:wght@400;600;700;800&display=swap"
    rel="stylesheet">
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* ── THEMES ── */
    :root,
    [data-theme="iron"] {
      --bg: #0e0e0e;
      --surface: #161616;
      --surface2: #202020;
      --border: #2c2c2c;
      --accent: #c0c0c0;
      --accent2: #888888;
      --btn-grad: linear-gradient(135deg, #909090 0%, #c0c0c0 50%, #d8d8d8 100%);
      --text: #e8e8e8;
      --muted: #565656;
      --muted2: #2c2c2c;
      --danger: #e05555;
    }

    [data-theme="midnight"] {
      --bg: #09090c;
      --surface: #111116;
      --surface2: #1a1a22;
      --border: #21212e;
      --accent: #00e5ff;
      --accent2: #7b61ff;
      --btn-grad: linear-gradient(135deg, #00c8e0 0%, #00e5ff 50%, #33eaff 100%);
      --text: #e4e4f0;
      --muted: #4a4a60;
      --muted2: #2e2e3e;
      --danger: #ff4d6d;
    }

    [data-theme="neon"] {
      --bg: #0a0014;
      --surface: #110020;
      --surface2: #1a0030;
      --border: #2d0050;
      --accent: #ff00ff;
      --accent2: #00ff88;
      --btn-grad: linear-gradient(135deg, #cc00cc 0%, #ff00ff 50%, #ff44ff 100%);
      --text: #f0e4ff;
      --muted: #5a3a70;
      --muted2: #2e1a40;
      --danger: #ff3355;
    }

    [data-theme="amber"] {
      --bg: #0d0a00;
      --surface: #141000;
      --surface2: #1f1800;
      --border: #2e2500;
      --accent: #ffaa00;
      --accent2: #ff6600;
      --btn-grad: linear-gradient(135deg, #cc8800 0%, #ffaa00 50%, #ffcc44 100%);
      --text: #f5e8c0;
      --muted: #5a4a20;
      --muted2: #2e2500;
      --danger: #ff4444;
    }

    [data-theme="frost"] {
      --bg: #f0f4f8;
      --surface: #ffffff;
      --surface2: #e8eef5;
      --border: #d0dae6;
      --accent: #0066cc;
      --accent2: #8800cc;
      --btn-grad: linear-gradient(135deg, #0055aa 0%, #0066cc 50%, #3388ee 100%);
      --text: #1a2030;
      --muted: #8090a8;
      --muted2: #c8d4e0;
      --danger: #cc2244;
    }

    [data-theme="forest"] {
      --bg: #020a04;
      --surface: #071208;
      --surface2: #0e1f10;
      --border: #1a3020;
      --accent: #00ff66;
      --accent2: #88ff00;
      --btn-grad: linear-gradient(135deg, #00cc44 0%, #00ff66 50%, #44ff88 100%);
      --text: #d0f0d8;
      --muted: #3a6040;
      --muted2: #1a2e1e;
      --danger: #ff4455;
    }

    [data-theme="rose"] {
      --bg: #0f0008;
      --surface: #1a0012;
      --surface2: #250020;
      --border: #380030;
      --accent: #ff6699;
      --accent2: #ff99cc;
      --btn-grad: linear-gradient(135deg, #cc3366 0%, #ff6699 50%, #ff88aa 100%);
      --text: #ffe0f0;
      --muted: #7a3a55;
      --muted2: #3a1028;
      --danger: #ff2244;
    }

    [data-theme="crimson"] {
      --bg: #0c0005;
      --surface: #160008;
      --surface2: #200010;
      --border: #3a0018;
      --accent: #ff2244;
      --accent2: #ff6655;
      --btn-grad: linear-gradient(135deg, #cc001a 0%, #ff2244 50%, #ff5566 100%);
      --text: #ffe0e4;
      --muted: #7a3040;
      --muted2: #3a0018;
      --danger: #ff6688;
    }

    [data-theme="ocean"] {
      --bg: #010a10;
      --surface: #051520;
      --surface2: #0a2030;
      --border: #0d3050;
      --accent: #00aaff;
      --accent2: #00ffcc;
      --btn-grad: linear-gradient(135deg, #0088dd 0%, #00aaff 50%, #33bbff 100%);
      --text: #d0f0ff;
      --muted: #2a6080;
      --muted2: #0a2030;
      --danger: #ff4477;
    }

    [data-theme="grape"] {
      --bg: #07010f;
      --surface: #100520;
      --surface2: #180830;
      --border: #28104a;
      --accent: #aa44ff;
      --accent2: #ff44cc;
      --btn-grad: linear-gradient(135deg, #8822ee 0%, #aa44ff 50%, #cc66ff 100%);
      --text: #f0e0ff;
      --muted: #6030a0;
      --muted2: #28104a;
      --danger: #ff3366;
    }

    [data-theme="slate"] {
      --bg: #080c10;
      --surface: #101820;
      --surface2: #182030;
      --border: #202c3a;
      --accent: #7ab8d8;
      --accent2: #a0d0e8;
      --btn-grad: linear-gradient(135deg, #5a98b8 0%, #7ab8d8 50%, #99ccee 100%);
      --text: #d0dde8;
      --muted: #405060;
      --muted2: #202c3a;
      --danger: #e05570;
    }

    [data-theme="gold"] {
      --bg: #0a0800;
      --surface: #141000;
      --surface2: #1e1800;
      --border: #332800;
      --accent: #f0c040;
      --accent2: #f08020;
      --btn-grad: linear-gradient(135deg, #c09020 0%, #f0c040 50%, #f8d860 100%);
      --text: #fff0c0;
      --muted: #705820;
      --muted2: #332800;
      --danger: #ff5544;
    }

    html {
      height: 100%;
    }

    body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Syne', sans-serif;
      overflow: hidden;
      transition: background 0.4s, color 0.4s;
    }

    /* ── DESKTOP LAYOUT ── */
    .app {
      display: grid;
      grid-template-columns: 280px 1fr 260px;
      grid-template-rows: 1fr 110px;
      height: 100vh;
    }

    /* ── SIDEBAR ── */
    .sidebar {
      grid-row: 1/2;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: background 0.4s, border-color 0.4s;
    }

    .sidebar-top {
      padding: 20px 18px 14px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .logo {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: -1px;
      color: var(--accent);
      font-family: 'Syne', sans-serif;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      line-height: 1;
    }

    .logo-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
      animation: blink 2s ease-in-out infinite;
      flex-shrink: 0;
      margin-top: 2px;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.3
      }
    }

    .logo-v {
      font-style: italic;
    }

    .api-status {
      font-size: 9px;
      font-family: 'DM Mono', monospace;
      color: var(--muted);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .api-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--muted);
      flex-shrink: 0;
      transition: background 0.3s;
    }

    .api-dot.ok {
      background: #00ff88;
      box-shadow: 0 0 6px #00ff88;
    }

    .api-dot.fail {
      background: var(--danger);
    }

    .api-dot.trying {
      background: #ffaa00;
      animation: blink 0.5s ease-in-out infinite;
    }

    .api-name-display {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 200px;
    }

    .search-wrap {
      position: relative;
    }

    .search-input {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      padding: 9px 36px 9px 12px;
      border-radius: 6px;
      outline: none;
      transition: border-color 0.2s;
    }

    .search-input:focus {
      border-color: var(--accent);
    }

    .search-input::placeholder {
      color: var(--muted);
    }

    .search-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 4px;
      display: flex;
      transition: color 0.2s;
    }

    .search-btn:hover {
      color: var(--accent);
    }

    .section-label {
      font-size: 9px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      padding: 12px 18px 6px;
      flex-shrink: 0;
    }

    .list-area {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    .list-empty {
      padding: 24px 18px;
      font-size: 11px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      line-height: 1.7;
    }

    /* ── TRACK / QUEUE ITEMS ── */
    .track-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 18px;
      cursor: pointer;
      transition: background 0.12s;
      position: relative;
    }

    .track-item:hover {
      background: var(--surface2);
    }

    .track-item.playing {
      background: rgba(0, 229, 255, 0.05);
    }

    .track-item.playing::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--accent);
    }

    /* cover slot — always reserves space */
    .thumb-slot {
      width: 38px;
      height: 38px;
      border-radius: 4px;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
    }

    .thumb-slot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 4px;
      display: block;
      transition: opacity 0.3s;
    }

    .thumb-slot .cover-placeholder {
      position: absolute;
      inset: 0;
      background: var(--muted2);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .thumb-slot .cover-placeholder svg {
      width: 16px;
      height: 16px;
      color: var(--muted);
    }

    .covers-hidden .thumb-slot img {
      opacity: 0;
    }

    .covers-hidden .thumb-slot .cover-placeholder {
      opacity: 1;
    }

    /* small queue thumbs */
    .q-thumb-slot {
      width: 30px;
      height: 30px;
      border-radius: 3px;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
    }

    .q-thumb-slot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: opacity 0.3s;
    }

    .q-thumb-slot .cover-placeholder {
      position: absolute;
      inset: 0;
      background: var(--muted2);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .q-thumb-slot .cover-placeholder svg {
      width: 12px;
      height: 12px;
      color: var(--muted);
    }

    .covers-hidden .q-thumb-slot img {
      opacity: 0;
    }

    .covers-hidden .q-thumb-slot .cover-placeholder {
      opacity: 1;
    }

    .track-meta {
      flex: 1;
      min-width: 0;
    }

    .track-title {
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
    }

    .track-artist {
      font-size: 10px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .track-dur {
      font-size: 10px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      flex-shrink: 0;
    }

    .add-btn {
      opacity: 0;
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      border-radius: 3px;
      padding: 2px 7px;
      font-size: 10px;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.12s;
      font-family: 'DM Mono', monospace;
      line-height: 1.6;
    }

    .track-item:hover .add-btn {
      opacity: 1;
    }

    .add-btn:hover {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    /* explicit badge */
    .explicit-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      border-radius: 2px;
      border: 1px solid var(--muted);
      color: var(--muted);
      font-size: 8px;
      font-family: 'DM Mono', monospace;
      font-weight: 700;
      flex-shrink: 0;
      opacity: 0.5;
      letter-spacing: 0;
      line-height: 1;
      margin-left: 3px;
      vertical-align: middle;
      transition: opacity 0.3s;
    }

    .covers-hidden.hide-explicit-with-covers .explicit-badge {
      opacity: 0;
    }

    /* ── MAIN ── */
    .main {
      grid-row: 1/2;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      padding: 32px;
    }

    .bg-blur {
      position: absolute;
      inset: -40px;
      background-size: cover;
      background-position: center;
      filter: blur(40px) saturate(1.8);
      opacity: 0.38;
      transform: scale(1.3);
      pointer-events: none;
      transition: background-image 1.2s ease, opacity 0.05s ease-out, transform 0.05s ease-out;
      will-change: transform, opacity;
    }

    .idle-msg {
      text-align: center;
      position: relative;
    }

    .idle-msg h2 {
      font-size: 28px;
      font-weight: 800;
      color: var(--muted);
      letter-spacing: -1px;
    }

    .idle-msg p {
      font-size: 11px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      margin-top: 8px;
      opacity: 0.6;
    }

    .playlists-wrap {
      position: absolute;
      inset: 0;
      z-index: 10;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: inherit;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .playlists-wrap.active {
      opacity: 1;
      pointer-events: auto;
    }

    .now-playing-wrap {
      display: none;
      flex-direction: column;
      align-items: center;
      text-align: center;
      position: relative;
    }

    .now-playing-wrap.visible {
      display: flex;
    }

    .album-art-outer {
      position: relative;
      margin-bottom: 28px;
    }

    .album-art {
      width: 220px;
      height: 220px;
      border-radius: 14px 14px 0 0;
      object-fit: cover;
      background: var(--surface2);
      box-shadow: 0 32px 80px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 255, 255, 0.04);
      display: block;
      transition: opacity 0.4s, filter 0.4s;
    }

    .art-cover-mask {
      position: absolute;
      inset: 0;
      border-radius: 14px;
      background: var(--muted2);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.4s;
      pointer-events: none;
      border: 1px solid var(--border);
    }

    .art-cover-mask svg {
      width: 40px;
      height: 40px;
      color: var(--muted);
    }

    .covers-hidden .album-art {
      opacity: 0;
    }

    .covers-hidden .art-cover-mask {
      opacity: 1;
    }

    .art-ring {
      position: absolute;
      inset: -8px;
      border-radius: 22px;
      border: 1px solid rgba(0, 229, 255, 0.12);
      pointer-events: none;
      animation: ring-pulse 3s ease-in-out infinite;
    }

    @keyframes ring-pulse {

      0%,
      100% {
        opacity: 0.4;
        transform: scale(1)
      }

      50% {
        opacity: 0.9;
        transform: scale(1.008)
      }
    }

    .art-ring2 {
      position: absolute;
      inset: -16px;
      border-radius: 28px;
      border: 1px solid rgba(0, 229, 255, 0.05);
      pointer-events: none;
      animation: ring-pulse 3s ease-in-out infinite 0.5s;
    }

    .np-title {
      font-size: 24px;
      font-weight: 800;
      letter-spacing: -0.5px;
      line-height: 1.2;
      margin-bottom: 6px;
      max-width: 380px;
    }

    .np-artist {
      font-size: 12px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      letter-spacing: 1px;
      margin-bottom: 3px;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    .np-album {
      font-size: 10px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      opacity: 0.5;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    .quality-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-top: 10px;
      background: rgba(0, 229, 255, 0.08);
      border: 1px solid rgba(0, 229, 255, 0.18);
      color: var(--accent);
      font-size: 9px;
      font-family: 'DM Mono', monospace;
      letter-spacing: 2px;
      padding: 3px 10px;
      border-radius: 3px;
      text-transform: uppercase;
    }

    /* ── QUEUE ── */
    .queue-panel {
      grid-row: 1/2;
      background: var(--surface);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: background 0.4s, border-color 0.4s;
    }

    .queue-header {
      padding: 20px 18px 10px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .queue-title {
      font-size: 10px;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--accent);
      font-family: 'DM Mono', monospace;
    }

    .queue-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .queue-count {
      font-size: 10px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
    }

    .clear-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 10px;
      font-family: 'DM Mono', monospace;
      transition: color 0.15s;
    }

    .clear-btn:hover {
      color: var(--danger);
    }

    .queue-list {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    .queue-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 14px;
      cursor: pointer;
      transition: background 0.12s;
      position: relative;
    }

    .queue-item:hover {
      background: var(--surface2);
    }

    .queue-item.current {
      background: rgba(0, 229, 255, 0.05);
    }

    .queue-item.current::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--accent);
    }

    .q-idx {
      font-size: 9px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      width: 14px;
      text-align: right;
      flex-shrink: 0;
    }

    .q-meta {
      flex: 1;
      min-width: 0;
    }

    .q-title {
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .q-artist {
      font-size: 9px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .q-remove {
      opacity: 0;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 12px;
      padding: 2px 4px;
      transition: color 0.12s;
      line-height: 1;
    }

    .queue-item:hover .q-remove {
      opacity: 1;
    }

    .q-remove:hover {
      color: var(--danger);
    }

    /* ── PLAYER BAR ── */
    .player-bar {
      grid-column: 1/-1;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 16px;
      transition: background 0.4s, border-color 0.4s;
    }

    .bar-track-info {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 200px;
      flex-shrink: 0;
    }

    .bar-thumb-wrap {
      width: 44px;
      height: 44px;
      border-radius: 6px;
      background: var(--muted2);
      flex-shrink: 0;
      overflow: hidden;
      position: relative;
    }

    .bar-thumb {
      width: 44px;
      height: 44px;
      object-fit: cover;
      display: none;
      transition: opacity 0.3s;
    }

    .bar-thumb-mask {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .bar-thumb-mask svg {
      width: 20px;
      height: 20px;
      color: var(--muted);
    }

    .covers-hidden .bar-thumb {
      opacity: 0;
    }

    .covers-hidden .bar-thumb-mask {
      opacity: 1;
    }

    .bar-title {
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }

    .bar-artist {
      font-size: 10px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }

    .controls {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .ctrl-btns {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .ctrl-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: color 0.15s;
    }

    .ctrl-btn:hover {
      color: var(--text);
    }

    .ctrl-btn svg {
      width: 16px;
      height: 16px;
    }

    .ctrl-btn.play-pause {
      width: 44px;
      height: 44px;
      background: var(--btn-grad);
      color: #fff;
      border-radius: 50%;
      transition: transform 0.15s, filter 0.15s;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    .ctrl-btn.play-pause:hover {
      transform: scale(1.06);
      filter: brightness(1.1);
    }

    .ctrl-btn.play-pause svg {
      width: 18px;
      height: 18px;
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
    }

    .progress-area {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .time-label {
      font-size: 10px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      flex-shrink: 0;
      width: 36px;
    }

    .time-label.end {
      text-align: right;
    }

    .progress-bar {
      flex: 1;
      height: 3px;
      background: var(--muted2);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      width: 0%;
      pointer-events: none;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      right: -4px;
      top: -3px;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--accent);
      opacity: 0;
      transition: opacity 0.15s;
    }

    .progress-bar:hover .progress-fill::after {
      opacity: 1;
    }

    .vol-wrap {
      position: relative;
    }

    .vol-icon-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 6px;
      display: flex;
    }

    .vol-popup {
      position: absolute;
      bottom: 44px;
      right: 0;
      width: 200px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: all 0.2s ease;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
      z-index: 500;
    }

    .vol-wrap.open .vol-popup {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .vol-row {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      color: var(--muted);
    }

    .vol-row input[type="range"] {
      width: 100%;
    }

    .vol-area {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 120px;
      flex-shrink: 0;
    }

    .vol-slider-container {
      width: 0;
      overflow: hidden;
      opacity: 0;
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s, padding-left 0.3s;
      display: flex;
      align-items: center;
      padding-left: 0;
    }

    .vol-wrap:hover .vol-slider-container {
      width: 100px;
      opacity: 1;
      padding-left: 10px;
    }

    .cf-slider-wrap {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: all 0.2s ease;
      z-index: 100;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .cf-wrap:hover .cf-slider-wrap {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .vol-icon {
      color: var(--muted);
      flex-shrink: 0;
    }

    .vol-icon svg {
      width: 14px;
      height: 14px;
      display: block;
    }

    .vol-slider {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 3px;
      background: var(--muted2);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
    }

    .vol-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--text);
      cursor: pointer;
    }

    .vol-slider:hover::-webkit-slider-thumb {
      background: var(--accent);
    }

    .bar-right-controls {
      display: flex;
      align-items: center;
      gap: 2px;
      flex-shrink: 0;
    }

    .icon-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 7px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: color 0.15s, background 0.15s;
    }

    .icon-btn:hover {
      color: var(--text);
      background: var(--surface2);
    }

    .icon-btn.active {
      color: var(--accent);
    }

    .icon-btn svg {
      width: 16px;
      height: 16px;
    }

    /* ── TOAST ── */
    .toast-wrap {
      position: fixed;
      bottom: 130px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 9999;
      pointer-events: none;
    }

    .toast {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 14px;
      font-size: 11px;
      font-family: 'DM Mono', monospace;
      color: var(--text);
      opacity: 0;
      transform: translateX(20px);
      transition: all 0.3s;
      max-width: 280px;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }

    .toast.error {
      border-color: var(--danger);
      color: var(--danger);
    }

    .toast.success {
      border-color: #00ff88;
      color: #00ff88;
    }

    .toast.warn {
      border-color: #ffaa00;
      color: #ffaa00;
    }

    .spin {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 1px solid var(--muted);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    /* ══════════════════════════════════════════════
   SETTINGS PANEL
══════════════════════════════════════════════ */
    .settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
      backdrop-filter: blur(4px);
    }

    .settings-overlay.open {
      opacity: 1;
      pointer-events: all;
    }

    .settings-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 380px;
      background: var(--surface);
      border-left: 1px solid var(--border);
      z-index: 1001;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    .settings-panel.open {
      transform: translateX(0);
    }

    .settings-header {
      padding: 22px 20px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .settings-title {
      font-size: 11px;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--accent);
      font-family: 'DM Mono', monospace;
    }

    .settings-close {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 4px;
      display: flex;
      transition: color 0.15s;
    }

    .settings-close:hover {
      color: var(--text);
    }

    .settings-body {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 0 0 40px;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    .settings-section {
      padding: 18px 20px 0;
    }

    .settings-section+.settings-section {
      margin-top: 6px;
    }

    .settings-section-title {
      font-size: 9px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      margin-bottom: 14px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    /* themes */
    .themes-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .theme-swatch {
      cursor: pointer;
      border-radius: 8px;
      padding: 8px 6px;
      border: 2px solid transparent;
      transition: all 0.15s;
    }

    .theme-swatch:hover {
      border-color: var(--border);
    }

    .theme-swatch.active {
      border-color: var(--accent);
    }

    .theme-swatch-preview {
      height: 26px;
      border-radius: 4px;
      margin-bottom: 6px;
      position: relative;
      overflow: hidden;
    }

    .theme-swatch-name {
      font-size: 9px;
      font-family: 'DM Mono', monospace;
      color: var(--muted);
      text-align: center;
      letter-spacing: 1px;
    }

    .theme-swatch.active .theme-swatch-name {
      color: var(--accent);
    }

    /* settings toggle */
    .settings-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 11px 0;
    }

    .settings-toggle-row+.settings-toggle-row {
      border-top: 1px solid var(--border);
    }

    .stl-label {
      font-size: 11px;
      color: var(--text);
    }

    .stl-sub {
      font-size: 9px;
      font-family: 'DM Mono', monospace;
      color: var(--muted);
      margin-top: 2px;
    }

    .toggle-switch {
      position: relative;
      width: 32px;
      height: 18px;
      flex-shrink: 0;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-track {
      position: absolute;
      inset: 0;
      background: var(--muted2);
      border-radius: 18px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toggle-track::after {
      content: '';
      position: absolute;
      left: 2px;
      top: 2px;
      width: 14px;
      height: 14px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s;
    }

    .toggle-switch input:checked+.toggle-track {
      background: var(--accent);
    }

    .toggle-switch input:checked+.toggle-track::after {
      transform: translateX(14px);
    }

    /* EQ — FIXED: vertical sliders in horizontal container */
    .eq-container {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px 12px 12px;
      overflow: hidden;
    }

    .eq-bands {
      display: flex;
      align-items: center;
      gap: 0;
      height: 140px;
      width: 100%;
    }

    .eq-band {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      height: 100%;
      min-width: 0;
      overflow: hidden;
    }

    .eq-value {
      font-size: 8px;
      font-family: 'DM Mono', monospace;
      color: var(--accent);
      text-align: center;
      flex-shrink: 0;
      height: 14px;
      line-height: 14px;
      width: 100%;
      overflow: hidden;
    }

    .eq-slider-wrap {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      overflow: hidden;
    }

    /* CRITICAL FIX: fixed-width rotated slider contained within parent */
    .eq-slider {
      -webkit-appearance: none;
      appearance: none;
      width: 80px;
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
      transform: rotate(-90deg);
      flex-shrink: 0;
    }

    .eq-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 0 5px var(--accent);
    }

    .eq-slider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: none;
    }

    .eq-label {
      font-size: 7px;
      font-family: 'DM Mono', monospace;
      color: var(--muted);
      text-align: center;
      letter-spacing: 0.3px;
      flex-shrink: 0;
      height: 14px;
      line-height: 14px;
    }

    .eq-preset-row {
      display: flex;
      gap: 5px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .eq-preset-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      padding: 4px 9px;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.12s;
      letter-spacing: 0.5px;
    }

    .eq-preset-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .eq-preset-btn.active {
      background: rgba(0, 229, 255, 0.1);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* API list */
    .api-list {
      display: flex;
      flex-direction: column;
      gap: 3px;
      max-height: 220px;
      overflow-y: auto;
    }

    .api-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 7px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.12s;
      border: 1px solid transparent;
    }

    .api-option:hover {
      background: var(--surface2);
    }

    .api-option.selected {
      border-color: var(--accent);
      background: rgba(0, 229, 255, 0.05);
    }

    .api-option-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--muted2);
      flex-shrink: 0;
      transition: background 0.3s;
    }

    .api-option.selected .api-option-dot {
      background: var(--accent);
      box-shadow: 0 0 6px var(--accent);
    }

    .api-option-name {
      font-size: 10px;
      font-family: 'DM Mono', monospace;
      color: var(--text);
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .api-option-status {
      font-size: 9px;
      font-family: 'DM Mono', monospace;
      color: var(--muted);
      flex-shrink: 0;
    }

    .api-option.selected .api-option-name {
      color: var(--accent);
    }

    .api-test-btn {
      margin-top: 10px;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      padding: 6px 14px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s;
      letter-spacing: 1px;
      text-transform: uppercase;
      width: 100%;
    }

    .api-test-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* ── FLIP CARD (HEART / STAR) ── */
    .flip-container {
      perspective: 1000px;
      position: relative;
    }

    .flip-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      transform-style: preserve-3d;
      transform-origin: center;
      border-radius: inherit;
    }

    .flip-container:hover .flip-inner {
      transform: rotateY(180deg);
    }

    .flip-front {
      position: relative;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: inherit;
      z-index: 2;
      overflow: hidden;
    }

    .flip-back {
      position: absolute;
      inset: 0;
      backface-visibility: hidden;
      border-radius: inherit;
      width: 100%;
      height: 100%;
      background: var(--surface2);
      transform: rotateY(180deg);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
      z-index: 1;
      overflow: hidden;
    }

    .flip-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      transition: transform 0.2s, filter 0.2s, color 0.2s;
      outline: none;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .flip-btn svg {
      width: 32px;
      height: 32px;
      fill: none;
      transition: fill 0.2s;
    }

    .flip-btn:hover {
      transform: scale(1.2);
    }

    .flip-btn.heart:hover,
    .flip-btn.heart.active {
      color: #ff2244;
      filter: drop-shadow(0 0 10px #ff2244);
    }

    .flip-btn.heart:hover svg,
    .flip-btn.heart.active svg {
      fill: #ff2244;
    }

    .flip-btn.star:hover,
    .flip-btn.star.active {
      color: #ffaa00;
      filter: drop-shadow(0 0 10px #ffaa00);
    }

    .flip-btn.star:hover svg,
    .flip-btn.star.active svg {
      fill: #ffaa00;
    }

    .fs-flip-btn svg {
      width: 48px;
      height: 48px;
    }

    .bar-flip-btn {
      gap: 12px;
    }

    .bar-flip-btn svg {
      width: 16px;
      height: 16px;
    }

    /* ══════════════════════════════════════════════
   FULLSCREEN — completely restructured
══════════════════════════════════════════════ */
    .fullscreen-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .fullscreen-overlay.open {
      opacity: 1;
      pointer-events: all;
    }

    .fullscreen-bg {
      position: absolute;
      inset: -60px;
      background-size: cover;
      background-position: center;
      filter: blur(50px) saturate(2.0);
      opacity: 0.55;
      transform: scale(1.4);
      pointer-events: none;
      transition: background-image 1s ease, opacity 0.05s ease-out, transform 0.05s ease-out;
      will-change: transform, opacity;
    }

    /* close button — top right, high z-index */
    .fullscreen-close {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 10;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text);
      cursor: pointer;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.15s;
      display: flex;
      backdrop-filter: blur(8px);
    }

    .fullscreen-close:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* main content — center column */
    .fullscreen-inner {
      position: relative;
      z-index: 1;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 40px 160px;
      gap: 32px;
      overflow: hidden;
    }

    .fullscreen-art-wrap {
      position: relative;
      flex-shrink: 0;
    }

    .fullscreen-art {
      width: min(55vh, 360px);
      height: min(55vh, 360px);
      border-radius: 18px;
      object-fit: cover;
      background: var(--surface2);
      box-shadow: 0 50px 140px rgba(0, 0, 0, 0.9);
      display: block;
      transition: opacity 0.4s;
    }

    .fullscreen-art-mask {
      position: absolute;
      inset: 0;
      border-radius: 18px;
      background: var(--surface2);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.4s;
      pointer-events: none;
    }

    .fullscreen-art-mask svg {
      width: 60px;
      height: 60px;
      color: var(--muted);
    }

    .covers-hidden .fullscreen-art {
      opacity: 0;
    }

    .covers-hidden .fullscreen-art-mask {
      opacity: 1;
    }

    .fs-ring1 {
      position: absolute;
      inset: -10px;
      border-radius: 24px;
      border: 1px solid rgba(0, 229, 255, 0.1);
      animation: ring-pulse 3s ease-in-out infinite;
      pointer-events: none;
    }

    .fs-ring2 {
      position: absolute;
      inset: -22px;
      border-radius: 32px;
      border: 1px solid rgba(0, 229, 255, 0.05);
      animation: ring-pulse 3s ease-in-out infinite 0.7s;
      pointer-events: none;
    }

    .fullscreen-meta {
      text-align: center;
      max-width: 600px;
    }

    .fullscreen-title {
      font-size: clamp(24px, 4.5vw, 52px);
      font-weight: 800;
      letter-spacing: -1px;
      line-height: 1.1;
      margin-bottom: 10px;
      text-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
    }

    .fullscreen-artist {
      font-size: clamp(11px, 1.6vw, 16px);
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      letter-spacing: 2px;
      margin-bottom: 4px;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    .fullscreen-album {
      font-size: 11px;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      opacity: 0.5;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    /* bottom controls bar */
    .fullscreen-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 2;
      padding: 20px 48px 32px;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.6) 0%, transparent 100%);
      display: flex;
      flex-direction: column;
      gap: 14px;
      align-items: center;
    }

    .fullscreen-progress {
      width: 100%;
      max-width: 640px;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .fullscreen-progress .time-label {
      font-size: 11px;
      width: 40px;
    }

    .fullscreen-controls {
      display: flex;
      align-items: center;
      gap: 28px;
    }

    .fs-ctrl-btn {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      padding: 8px;
      display: flex;
      border-radius: 50%;
      transition: color 0.15s, transform 0.1s;
    }

    .fs-ctrl-btn:hover {
      color: #fff;
      transform: scale(1.1);
    }

    .fs-ctrl-btn svg {
      width: 22px;
      height: 22px;
    }

    /* FIXED: play button centered with flex */
    .fs-ctrl-btn.play-pause {
      width: 58px;
      height: 58px;
      background: var(--btn-grad);
      color: #fff;
      border-radius: 50%;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .fs-ctrl-btn.play-pause:hover {
      transform: scale(1.06);
      filter: brightness(1.1);
    }

    .fs-ctrl-btn.play-pause svg {
      width: 22px;
      height: 22px;
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
    }

    /* ══════════════════════════════════════════════
   MOBILE LAYOUT
══════════════════════════════════════════════ */
    @media (max-width: 700px) {
      body {
        overflow: hidden;
      }

      .app {
        display: flex;
        flex-direction: column;
        height: 100dvh;
        overflow: hidden;
      }

      .sidebar {
        display: none;
      }

      .queue-panel {
        display: none;
      }

      .main {
        flex: 1;
        padding: 20px 20px 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        overflow: hidden;
      }

      .bg-blur {
        filter: blur(80px) saturate(0.5);
      }

      .album-art {
        width: 200px;
        height: 200px;
      }

      .album-art-outer {
        margin-bottom: 20px;
      }

      .np-title {
        font-size: 20px;
      }

      .player-bar {
        padding: 0 16px;
        gap: 10px;
        height: auto;
        min-height: 110px;
        flex-shrink: 0;
        flex-wrap: wrap;
        align-content: center;
      }

      .bar-track-info {
        width: 100%;
        gap: 10px;
      }

      .controls {
        width: 100%;
        order: 3;
      }

      .vol-area {
        display: none;
      }

      .bar-right-controls {
        order: 2;
        margin-left: auto;
      }

      /* mobile bottom tabs */
      .mobile-tabs {
        display: flex;
        background: var(--surface);
        border-top: 1px solid var(--border);
        flex-shrink: 0;
      }

      .mobile-tab {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 10px 8px;
        gap: 4px;
        cursor: pointer;
        border: none;
        background: none;
        color: var(--muted);
        font-family: 'DM Mono', monospace;
        font-size: 8px;
        letter-spacing: 1px;
        transition: color 0.15s;
      }

      .mobile-tab.active {
        color: var(--accent);
      }

      .mobile-tab svg {
        width: 18px;
        height: 18px;
      }

      /* mobile panels */
      .mobile-panel {
        display: none;
        flex: 1;
        overflow: hidden;
        flex-direction: column;
      }

      .mobile-panel.active {
        display: flex;
      }

      .m-search-panel {
        flex-direction: column;
        overflow: hidden;
      }

      .m-search-top {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
      }

      .m-queue-panel {
        flex-direction: column;
        overflow: hidden;
      }

      .m-queue-header {
        padding: 14px 16px 10px;
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* hide mobile tabs on desktop */
    }

    @media (min-width: 701px) {
      .mobile-tabs {
        display: none !important;
      }

      .mobile-panel {
        display: none !important;
      }
    }

    /* ── BEAT REACTIVE BG ── */
    @keyframes beatPulse {
      0% {
        transform: scale(1.3);
      }

      50% {
        transform: scale(1.38);
      }

      100% {
        transform: scale(1.3);
      }
    }

    .bg-blur.beat {
      animation: beatPulse 0.25s ease-out;
    }
  </style>
</head>

<body>
  <div class="app" id="appRoot">

    <!-- SIDEBAR (desktop) -->
    <aside class="sidebar">
      <div class="sidebar-top">
        <div class="logo"><span class="logo-dot"></span><span class="logo-v"></span>audia</div>
        <div class="api-status">
          <span class="api-dot" id="apiDot"></span>
          <span class="api-name-display" id="apiName">connecting…</span>
        </div>
        <div class="search-wrap">
          <input class="search-input" id="searchInput" type="text" placeholder="search tracks, artists…"
            autocomplete="off">
          <button class="search-btn" id="searchBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
          </button>
        </div>
        <button class="api-test-btn" id="showPlaylistsBtn"
          style="margin-top:14px; text-transform:lowercase; width:100%; border-color:var(--border);">view
          playlists</button>
      </div>
      <div class="section-label" id="resultsLabel">results</div>
      <div class="list-area" id="searchResults">
        <div class="list-empty">search for something.<br><span style="opacity:0.5">or don't. nobody's forcing
            you.</span></div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main" id="mainArea">
      <div class="bg-blur" id="bgBlur"></div>
      <div class="idle-msg" id="idleMsg">
        <h2>nothing playing</h2>
        <p>search → add to queue → press play</p>
      </div>

      <div class="playlists-wrap" id="playlistsWrap">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 style="font-size:24px; font-weight:800; color:var(--text);">playlists</h2>
          <div style="display:flex; gap:12px;">
            <button class="icon-btn" onclick="createPlaylist()"
              style="background:var(--accent); color:var(--bg); padding:6px 12px; border-radius:12px; font-weight:bold; font-size:12px;">+
              new</button>
            <button class="icon-btn" id="closePlaylistsBtn" style="background:var(--surface2);">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
              </svg>
            </button>
          </div>
        </div>
        <div id="playlistsContent" style="display:flex; flex-direction:column; gap:20px;"></div>
      </div>

      <div class="now-playing-wrap" id="nowPlayingWrap">
        <div class="album-art-outer flip-container">
          <div class="flip-inner">
            <div class="flip-front">
              <img class="album-art" id="mainArt" src="" alt="album art">
              <div class="art-cover-mask">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <rect x="3" y="3" width="18" height="18" rx="2" />
                  <circle cx="8.5" cy="8.5" r="1.5" />
                  <line x1="3" y1="21" x2="9" y2="13" />
                  <path d="M9 13l4-4 4 8" />
                  <line x1="15" y1="11" x2="21" y2="3" />
                </svg>
              </div>
            </div>
            <div class="flip-back album-art">
              <button class="flip-btn heart" onclick="addTaste()" title="Add to Taste Profile">
                <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path
                    d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                </svg>
              </button>
              <button class="flip-btn star" onclick="addFavorite()" title="Favorite Song">
                <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <polygon
                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                </svg>
              </button>
            </div>
          </div>
          <div class="art-ring"></div>
          <div class="art-ring2"></div>
        </div>
        <div class="np-title" id="npTitle">—</div>
        <div class="np-artist" id="npArtist">—</div>
        <div class="np-album" id="npAlbum">—</div>
        <div class="quality-badge" id="qualityBadge">◆ LOSSLESS</div>
      </div>
    </main>

    <!-- QUEUE PANEL (desktop) -->
    <aside class="queue-panel">
      <div class="queue-header">
        <span class="queue-title">queue</span>
        <div class="queue-right">
          <span class="queue-count" id="queueCount">0 tracks</span>
          <div class="cf-wrap" style="position:relative; display:inline-flex; align-items:center;">
            <button class="icon-btn" id="crossfadeBtn" title="Crossfade" style="opacity:0.4;padding:5px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15">
                <path d="M2 2l5 5M22 2l-5 5" />
                <path d="M17 7c0 5-5 5-5 10s-5 5-5 10" />
                <path d="M7 7c0 5 5 5 5 10s5 5 5 10" />
              </svg>
            </button>
            <div class="cf-slider-wrap">
              <input type="range" id="cfSlider" min="1" max="10" step="1" value="3">
              <span id="cfVal"
                style="font-size:10px; font-family:'DM Mono',monospace; width:20px; text-align:right;">3s</span>
            </div>
          </div>
          <button class="icon-btn" id="autoplayBtn" title="Autoplay" style="opacity:0.4;padding:5px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" />
              <path d="M9.5 8.96l6.52 3.04-6.52 3.04V8.96z" fill="currentColor" stroke="none" />
              <path d="M4 6h2M18 6h2M4 18h2M18 18h2" stroke-linecap="round" />
            </svg>
          </button>
          <button class="clear-btn" id="clearQueueBtn">clear</button>
        </div>
      </div>
      <div class="queue-list" id="queueList">
        <div class="list-empty">queue is empty.<br><span style="opacity:0.5">add tracks from search.</span></div>
      </div>
    </aside>

    <!-- PLAYER BAR -->
    <div class="player-bar">
      <div class="bar-track-info">
        <div class="bar-thumb-wrap">
          <img class="bar-thumb" id="barThumb" src="" alt="">
          <div class="bar-thumb-mask">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2" />
              <circle cx="8.5" cy="8.5" r="1.5" />
              <line x1="3" y1="21" x2="9" y2="13" />
              <path d="M9 13l4-4 4 8" />
              <line x1="15" y1="11" x2="21" y2="3" />
            </svg>
          </div>
        </div>
        <div>
          <div class="bar-title" id="barTitle">—</div>
          <div class="bar-artist" id="barArtist">—</div>
        </div>
      </div>
      <div class="controls">
        <div class="ctrl-btns">
          <button class="ctrl-btn" id="restartBtn" title="Restart">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="1 4 1 10 7 10" />
              <path d="M3.51 15a9 9 0 1 0 .49-4.45" />
            </svg>
          </button>
          <button class="ctrl-btn" id="prevBtn">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 20L9 12l10-8v16z" />
              <rect x="5" y="4" width="2" height="16" rx="1" />
            </svg>
          </button>
          <button class="ctrl-btn play-pause" id="playPauseBtn">
            <svg id="playIcon" viewBox="0 0 24 24" fill="currentColor">
              <polygon points="6,3 20,12 6,21" />
            </svg>
            <svg id="pauseIcon" viewBox="0 0 24 24" fill="currentColor" style="display:none">
              <rect x="6" y="4" width="4" height="16" rx="1" />
              <rect x="14" y="4" width="4" height="16" rx="1" />
            </svg>
          </button>
          <button class="ctrl-btn" id="nextBtn">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M5 4l10 8-10 8V4z" />
              <rect x="17" y="4" width="2" height="16" rx="1" />
            </svg>
          </button>
          <button class="ctrl-btn" id="shuffleBtn" style="opacity:0.3">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="16 3 21 3 21 8" />
              <line x1="4" y1="20" x2="21" y2="3" />
              <polyline points="21 16 21 21 16 21" />
              <line x1="15" y1="15" x2="21" y2="21" />
            </svg>
          </button>
        </div>
        <div class="progress-area">
          <span class="time-label" id="currentTime">0:00</span>
          <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <span class="time-label end" id="totalTime">0:00</span>
        </div>
      </div>
      <div class="vol-area">
        <div class="vol-wrap" id="volWrap"
          style="position:relative; display:flex; align-items:center; padding-right:10px;">
          <button class="vol-icon-btn" id="volIconBtn" style="flex-shrink:0;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
              <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" />
            </svg>
          </button>
          <div class="vol-slider-container">
            <input type="range" id="volSlider" min="0" max="1" step="0.01" value="0.8" style="width:100%;">
          </div>
        </div>
      </div>
      <div class="bar-right-controls">
        <button class="icon-btn" id="coverToggleBtn" title="Toggle album covers">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" />
            <circle cx="8.5" cy="8.5" r="1.5" />
            <line x1="3" y1="21" x2="9" y2="13" />
            <path d="M9 13l4-4 4 8" />
            <line x1="15" y1="11" x2="21" y2="3" />
          </svg>
        </button>
        <button class="icon-btn" id="fullscreenBtn" title="Fullscreen (F)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 3 21 3 21 9" />
            <polyline points="9 21 3 21 3 15" />
            <line x1="21" y1="3" x2="14" y2="10" />
            <line x1="3" y1="21" x2="10" y2="14" />
          </svg>
        </button>
        <button class="icon-btn" id="settingsBtn" title="Settings">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3" />
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" />
          </svg>
        </button>
      </div>
    </div>

    <!-- MOBILE TABS -->
    <div class="mobile-tabs">
      <button class="mobile-tab active" id="mTabNow" onclick="switchMobileTab('now')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" />
          <polygon points="10,8 16,12 10,16" />
        </svg>
        now playing
      </button>
      <button class="mobile-tab" id="mTabSearch" onclick="switchMobileTab('search')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8" />
          <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </svg>
        search
      </button>
      <button class="mobile-tab" id="mTabQueue" onclick="switchMobileTab('queue')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="8" y1="6" x2="21" y2="6" />
          <line x1="8" y1="12" x2="21" y2="12" />
          <line x1="8" y1="18" x2="21" y2="18" />
          <line x1="3" y1="6" x2="3.01" y2="6" />
          <line x1="3" y1="12" x2="3.01" y2="12" />
          <line x1="3" y1="18" x2="3.01" y2="18" />
        </svg>
        queue
      </button>
    </div>
  </div>

  <!-- MOBILE PANELS (injected below app) -->
  <div class="mobile-panel m-search-panel" id="mSearchPanel">
    <div class="m-search-top">
      <div class="search-wrap">
        <input class="search-input" id="mSearchInput" type="text" placeholder="search tracks, artists…"
          autocomplete="off">
        <button class="search-btn" id="mSearchBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
          </svg>
        </button>
      </div>
    </div>
    <div class="list-area" id="mSearchResults">
      <div class="list-empty">search for something.</div>
    </div>
  </div>
  <div class="mobile-panel m-queue-panel" id="mQueuePanel">
    <div class="m-queue-header">
      <span
        style="font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--accent);font-family:'DM Mono',monospace;">queue</span>
      <button class="clear-btn" id="mClearQueueBtn">clear</button>
    </div>
    <div class="queue-list" id="mQueueList">
      <div class="list-empty">queue is empty.</div>
    </div>
  </div>

  <!-- SETTINGS OVERLAY -->
  <div class="settings-overlay" id="settingsOverlay"></div>
  <!-- SETTINGS PANEL -->
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-header">
      <span class="settings-title">settings</span>
      <button class="settings-close" id="settingsClose">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
    </div>
    <div class="settings-body">
      <div class="settings-section">
        <div class="settings-section-title">theme</div>
        <div class="themes-grid" id="themesGrid"></div>
      </div>
      <div class="settings-section" style="margin-top:18px;">
        <div class="settings-section-title">display</div>
        <div class="settings-toggle-row">
          <div>
            <div class="stl-label">hide explicit symbols with covers</div>
            <div class="stl-sub">hides ᴇ badge when covers are hidden</div>
          </div>
          <label class="toggle-switch"><input type="checkbox" id="toggleHideExplicit" checked><span
              class="toggle-track"></span></label>
        </div>
        <div class="settings-toggle-row">
          <div>
            <div class="stl-label">anti-epilepsy</div>
            <div class="stl-sub">disables the reactive background pulsing</div>
          </div>
          <label class="toggle-switch"><input type="checkbox" id="toggleAntiEpilepsy"><span
              class="toggle-track"></span></label>
        </div>
      </div>
      <div class="settings-section" style="margin-top:18px;">
        <div class="settings-section-title">equalizer</div>
        <div class="eq-container">
          <div class="eq-bands" id="eqBands"></div>
          <div class="eq-preset-row" id="eqPresets"></div>
        </div>
      </div>
      <div class="settings-section" style="margin-top:18px;">
        <div class="settings-section-title">api instance</div>
        <div class="api-list" id="apiList"></div>
        <button class="api-test-btn" id="retestApiBtn">↻ test all instances</button>
      </div>
    </div>
  </div>

  <!-- FULLSCREEN OVERLAY -->
  <div class="fullscreen-overlay" id="fullscreenOverlay">
    <div class="fullscreen-bg" id="fullscreenBg"></div>
    <!-- FIXED close button: high z-index, absolute positioned -->
    <button class="fullscreen-close" id="fullscreenClose" style="z-index:10;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
        <line x1="18" y1="6" x2="6" y2="18" />
        <line x1="6" y1="6" x2="18" y2="18" />
      </svg>
    </button>
    <div class="fullscreen-inner">
      <div class="fullscreen-art-wrap flip-container">
        <div class="flip-inner">
          <div class="flip-front">
            <img class="fullscreen-art" id="fullscreenArt" src="" alt="">
            <div class="fullscreen-art-mask">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="18" height="18" rx="2" />
                <circle cx="8.5" cy="8.5" r="1.5" />
                <line x1="3" y1="21" x2="9" y2="13" />
                <path d="M9 13l4-4 4 8" />
                <line x1="15" y1="11" x2="21" y2="3" />
              </svg>
            </div>
          </div>
          <div class="flip-back fullscreen-art">
            <button class="flip-btn heart fs-flip-btn" onclick="addTaste()" title="Add to Taste Profile">
              <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path
                  d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
              </svg>
            </button>
            <button class="flip-btn star fs-flip-btn" onclick="addFavorite()" title="Favorite Song">
              <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <polygon
                  points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
              </svg>
            </button>
          </div>
        </div>
        <div class="fs-ring1"></div>
        <div class="fs-ring2"></div>
      </div>
      <div class="fullscreen-meta">
        <div class="fullscreen-title" id="fullscreenTitle">—</div>
        <div class="fullscreen-artist" id="fullscreenArtist">—</div>
        <div class="fullscreen-album" id="fullscreenAlbum">—</div>
      </div>
    </div>
    <div class="fullscreen-bar">
      <div class="fullscreen-progress">
        <span class="time-label" id="fsCurrentTime">0:00</span>
        <div class="progress-bar" id="fsProgressBar" style="flex:1;">
          <div class="progress-fill" id="fsProgressFill"></div>
        </div>
        <span class="time-label end" id="fsTotalTime">0:00</span>
      </div>
      <div class="fullscreen-controls">
        <button class="fs-ctrl-btn" id="fsPrevBtn"><svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 20L9 12l10-8v16z" />
            <rect x="5" y="4" width="2" height="16" rx="1" />
          </svg></button>
        <button class="fs-ctrl-btn play-pause" id="fsPlayPauseBtn">
          <svg id="fsPlayIcon" viewBox="0 0 24 24" fill="currentColor">
            <polygon points="6,3 20,12 6,21" />
          </svg>
          <svg id="fsPauseIcon" viewBox="0 0 24 24" fill="currentColor" style="display:none">
            <rect x="6" y="4" width="4" height="16" rx="1" />
            <rect x="14" y="4" width="4" height="16" rx="1" />
          </svg>
        </button>
        <button class="fs-ctrl-btn" id="fsNextBtn"><svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M5 4l10 8-10 8V4z" />
            <rect x="17" y="4" width="2" height="16" rx="1" />
          </svg></button>
      </div>
    </div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>
  <audio id="audioEl" preload="none" crossorigin="anonymous"></audio>

  <script>
    /*
     * audia — internal watermark
     * build: aud-7f3c9e2a | project: audia | do not redistribute
     * if you're reading this, hello. please don't steal it.
     */
    const _vlt = { id: 'audia', v: '3.0.0', sig: 'aud-7f3c9e2a-d154-4b8f-a367-e9c2b5d10f43' };
    Object.freeze(_vlt);

    // ══════════════════════════════════════════════════════
    //  INSTANCES
    // ══════════════════════════════════════════════════════
    const API_INSTANCES = [
      'https://eu-central.monochrome.tf',
      'https://us-west.monochrome.tf',
      'https://triton.squid.wtf',
      'https://api.monochrome.tf',
      'https://monochrome-api.samidy.com',
      'https://wolf.qqdl.site',
      'https://maus.qqdl.site',
      'https://vogel.qqdl.site',
      'https://katze.qqdl.site',
      'https://hund.qqdl.site',
      'https://tidal.kinoplus.online',
    ];
    const STREAM_INSTANCES = [
      'https://triton.squid.wtf', 'https://wolf.qqdl.site', 'https://maus.qqdl.site',
      'https://vogel.qqdl.site', 'https://katze.qqdl.site', 'https://hund.qqdl.site',
    ];
    let activeApi = null, activeStream = null, manualApiOverride = null;
    const apiStatuses = {};

    // ══════════════════════════════════════════════════════
    //  AUDIO + WEB AUDIO CONTEXT
    // ══════════════════════════════════════════════════════
    const audio = document.getElementById('audioEl');
    let audioCtx = null, eqFilters = [], gainNode = null, analyser = null;
    let eqReady = false;

    function initAudioContext() {
      if (audioCtx) return;
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        gainNode = audioCtx.createGain();
        gainNode.gain.value = 1;
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        analyser.smoothingTimeConstant = 0.8;

        eqFilters = EQ_BANDS.map((band, i) => {
          const f = audioCtx.createBiquadFilter();
          f.type = i === 0 ? 'lowshelf' : i === EQ_BANDS.length - 1 ? 'highshelf' : 'peaking';
          f.frequency.value = band.freq;
          f.gain.value = 0; f.Q.value = 1.4;
          return f;
        });
        const src = audioCtx.createMediaElementSource(audio);
        let node = src;
        eqFilters.forEach(f => { node.connect(f); node = f; });
        node.connect(gainNode);
        gainNode.connect(analyser);
        analyser.connect(audioCtx.destination);
        eqReady = true;
        startBeatDetection();
      } catch (e) { console.warn('Web Audio unavailable:', e); }
    }

    // ── BEAT DETECTION ──
    let beatRafId = null;
    const beatBuf = new Uint8Array(1024);

    function startBeatDetection() {
      if (!analyser) return;
      const bgBlur = document.getElementById('bgBlur');
      const fsBg = document.getElementById('fullscreenBg');

      function tick() {
        beatRafId = requestAnimationFrame(tick);

        if (antiEpilepsyMode) {
          bgBlur.style.transform = 'scale(1.3)';
          bgBlur.style.opacity = '0.38';
          fsBg.style.transform = 'scale(1.4)';
          fsBg.style.opacity = '0.55';
          return;
        }

        analyser.getByteFrequencyData(beatBuf);

        // 44100Hz / 2048 = 21.5Hz per bin
        // Average energy in bins 2 to 6 (approx 43Hz - 129Hz)
        let bassEnergy = 0;
        for (let i = 2; i <= 6; i++) bassEnergy += beatBuf[i];
        bassEnergy /= 5;

        // Exponential curve for direct visual correlation to bass volume
        const normalized = bassEnergy / 255;
        const strength = Math.pow(normalized, 1.8);

        const scale = 1.25 + strength * 0.25;
        const opBlur = 0.2 + strength * 0.45;

        const fsScale = 1.3 + strength * 0.25;
        const opFs = 0.3 + strength * 0.55;

        bgBlur.style.transform = `scale(${scale})`;
        bgBlur.style.opacity = opBlur.toString();

        fsBg.style.transform = `scale(${fsScale})`;
        fsBg.style.opacity = opFs.toString();
      }
      tick();
    }

    // ══════════════════════════════════════════════════════
    //  EQ
    // ══════════════════════════════════════════════════════
    const EQ_BANDS = [
      { freq: 60, label: '60Hz' }, { freq: 170, label: '170Hz' }, { freq: 350, label: '350Hz' },
      { freq: 1000, label: '1kHz' }, { freq: 3500, label: '3.5k' }, { freq: 10000, label: '10kHz' },
      { freq: 16000, label: '16kHz' },
    ];
    const EQ_PRESETS = {
      flat: [0, 0, 0, 0, 0, 0, 0], 'bass+': [8, 6, 4, 0, -1, -1, -2], 'treble+': [-2, -1, 0, 1, 4, 6, 7],
      vocal: [-3, -2, 2, 4, 3, 2, 1], loudness: [5, 3, 0, -1, 0, 3, 5], hifi: [3, 1, 0, -1, 0, 2, 4],
    };
    let eqValues = [0, 0, 0, 0, 0, 0, 0];
    let activeEqPreset = 'flat';

    function setEqBand(i, db) { if (eqFilters[i]) eqFilters[i].gain.value = db; }

    function renderEqBands() {
      const c = document.getElementById('eqBands');
      c.innerHTML = '';
      EQ_BANDS.forEach((band, i) => {
        const v = eqValues[i];
        const d = document.createElement('div');
        d.className = 'eq-band';
        d.innerHTML = `<div class="eq-value" id="eqVal${i}">${v > 0 ? '+' : ''}${v}</div>
      <div class="eq-slider-wrap"><input class="eq-slider" id="eqSlider${i}" type="range" min="-12" max="12" step="0.5" value="${v}"></div>
      <div class="eq-label">${band.label}</div>`;
        c.appendChild(d);
        d.querySelector(`#eqSlider${i}`).addEventListener('input', e => {
          const val = parseFloat(e.target.value);
          eqValues[i] = val;
          document.getElementById('eqVal' + i).textContent = (val > 0 ? '+' : '') + val;
          setEqBand(i, val);
          activeEqPreset = null; renderEqPresets();
        });
      });
    }

    function applyEqPreset(name) {
      const vals = EQ_PRESETS[name]; if (!vals) return;
      activeEqPreset = name;
      vals.forEach((v, i) => {
        eqValues[i] = v; setEqBand(i, v);
        const s = document.getElementById('eqSlider' + i);
        const l = document.getElementById('eqVal' + i);
        if (s) s.value = v;
        if (l) l.textContent = (v > 0 ? '+' : '') + v;
      });
      renderEqPresets();
    }

    function renderEqPresets() {
      const row = document.getElementById('eqPresets');
      row.innerHTML = '';
      Object.keys(EQ_PRESETS).forEach(name => {
        const btn = document.createElement('button');
        btn.className = 'eq-preset-btn' + (activeEqPreset === name ? ' active' : '');
        btn.textContent = name;
        btn.addEventListener('click', () => { applyEqPreset(name); toast('eq: ' + name, '', 1500); });
        row.appendChild(btn);
      });
    }

    // ══════════════════════════════════════════════════════
    //  THEMES
    // ══════════════════════════════════════════════════════
    const THEMES = [
      { id: 'iron', name: 'iron', bg: '#0d0d0d', accent: '#ffffff', surface: '#1a1a1a' },
      { id: 'crimson', name: 'crimson', bg: '#140000', accent: '#ff3333', surface: '#220000' },
      { id: 'ocean', name: 'ocean', bg: '#000814', accent: '#3388ff', surface: '#001122' },
      { id: 'grape', name: 'grape', bg: '#0d0014', accent: '#b955ff', surface: '#1a0026' },
      { id: 'slate', name: 'slate', bg: '#101418', accent: '#88aacc', surface: '#1a2026' },
      { id: 'gold', name: 'gold', bg: '#141100', accent: '#ffcc00', surface: '#262100' },
      { id: 'midnight', name: 'midnight', bg: '#09090c', accent: '#00e5ff', surface: '#111116' },
      { id: 'neon', name: 'neon', bg: '#0a0014', accent: '#ff00ff', surface: '#110020' },
      { id: 'amber', name: 'amber', bg: '#0d0a00', accent: '#ffaa00', surface: '#141000' },
      { id: 'frost', name: 'frost', bg: '#f0f4f8', accent: '#0066cc', surface: '#ffffff' },
      { id: 'forest', name: 'forest', bg: '#020a04', accent: '#00ff66', surface: '#071208' },
      { id: 'rose', name: 'rose', bg: '#0f0008', accent: '#ff6699', surface: '#1a0012' },
    ];
    let currentTheme = 'midnight';

    function applyTheme(id) {
      currentTheme = id;
      document.documentElement.setAttribute('data-theme', id);
      document.getElementById('appRoot').setAttribute('data-theme', id);
      renderThemeSwatches();
    }

    function renderThemeSwatches() {
      const grid = document.getElementById('themesGrid');
      grid.innerHTML = '';
      THEMES.forEach(t => {
        const sw = document.createElement('div');
        sw.className = 'theme-swatch' + (t.id === currentTheme ? ' active' : '');
        sw.innerHTML = `<div class="theme-swatch-preview" style="background:linear-gradient(135deg,${t.bg} 0%,${t.surface} 40%,${t.accent}44 100%);border:1px solid ${t.accent}33;"><div style="position:absolute;bottom:4px;right:5px;width:7px;height:7px;border-radius:50%;background:${t.accent};box-shadow:0 0 5px ${t.accent};"></div></div><div class="theme-swatch-name" style="${t.id === currentTheme ? 'color:' + t.accent : ''}">${t.name}</div>`;
        sw.addEventListener('click', () => { applyTheme(t.id); toast('theme: ' + t.name, '', 1500); });
        grid.appendChild(sw);
      });
    }

    // ══════════════════════════════════════════════════════
    //  SETTINGS
    // ══════════════════════════════════════════════════════
    let hideExplicitWithCovers = true;
    let antiEpilepsyMode = false;

    function openSettings() {
      document.getElementById('settingsPanel').classList.add('open');
      document.getElementById('settingsOverlay').classList.add('open');
      renderApiList();
    }
    function closeSettings() {
      document.getElementById('settingsPanel').classList.remove('open');
      document.getElementById('settingsOverlay').classList.remove('open');
    }
    document.getElementById('settingsBtn').addEventListener('click', openSettings);
    document.getElementById('settingsClose').addEventListener('click', closeSettings);
    document.getElementById('settingsOverlay').addEventListener('click', closeSettings);
    document.getElementById('toggleHideExplicit').addEventListener('change', e => {
      hideExplicitWithCovers = e.target.checked;
      updateCoversHiddenClass();
    });

    document.getElementById('toggleAntiEpilepsy').addEventListener('change', e => {
      antiEpilepsyMode = e.target.checked;
    });

    // ══════════════════════════════════════════════════════
    //  COVER TOGGLE
    // ══════════════════════════════════════════════════════
    let coversHidden = false;

    function updateCoversHiddenClass() {
      const root = document.getElementById('appRoot');
      const fs = document.getElementById('fullscreenOverlay');
      root.classList.toggle('covers-hidden', coversHidden);
      fs.classList.toggle('covers-hidden', coversHidden);
      root.classList.toggle('hide-explicit-with-covers', coversHidden && hideExplicitWithCovers);
      fs.classList.toggle('hide-explicit-with-covers', coversHidden && hideExplicitWithCovers);
    }

    document.getElementById('coverToggleBtn').addEventListener('click', () => {
      coversHidden = !coversHidden;
      updateCoversHiddenClass();
      document.getElementById('coverToggleBtn').classList.toggle('active', coversHidden);
      toast('covers ' + (coversHidden ? 'hidden' : 'visible'), '', 1500);
    });

    // ══════════════════════════════════════════════════════
    //  FULLSCREEN
    // ══════════════════════════════════════════════════════
    function openFullscreen() {
      document.getElementById('fullscreenOverlay').classList.add('open');
    }
    function closeFullscreen() {
      document.getElementById('fullscreenOverlay').classList.remove('open');
    }

    document.getElementById('fullscreenBtn').addEventListener('click', openFullscreen);
    // FIXED: direct click listener, no interference from other elements
    document.getElementById('fullscreenClose').addEventListener('click', e => {
      e.stopPropagation();
      closeFullscreen();
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') { closeFullscreen(); closeSettings(); }
      if ((e.key === 'f' || e.key === 'F') && document.activeElement?.tagName !== 'INPUT') openFullscreen();
    });

    // FS controls
    document.getElementById('fsPlayPauseBtn').addEventListener('click', () => {
      if (!queue.length) return;
      if (queueIdx < 0) { playFromQueue(0); return; }
      if (!audio.src || audio.src === window.location.href) { playFromQueue(queueIdx); return; }
      if (isPlaying) { audio.pause(); setPlayState(false); }
      else { audio.play(); setPlayState(true); }
    });
    document.getElementById('fsPrevBtn').addEventListener('click', () => {
      if (audio.currentTime > 3) { audio.currentTime = 0; return; }
      if (queueIdx > 0) playFromQueue(queueIdx - 1); else audio.currentTime = 0;
    });
    document.getElementById('fsNextBtn').addEventListener('click', () => {
      if (!queue.length) return;
      if (isShuffle) { playFromQueue(Math.floor(Math.random() * queue.length)); return; }
      if (queueIdx < queue.length - 1) playFromQueue(queueIdx + 1);
      else toast('last track, genius.', '', 2000);
    });
    document.getElementById('fsProgressBar').addEventListener('click', e => {
      if (!audio.duration) return;
      const r = e.currentTarget.getBoundingClientRect();
      audio.currentTime = ((e.clientX - r.left) / r.width) * audio.duration;
    });

    // ══════════════════════════════════════════════════════
    //  API HEALTH + SELECTOR
    // ══════════════════════════════════════════════════════
    const apiDot = document.getElementById('apiDot');
    const apiNameEl = document.getElementById('apiName');

    async function testInstance(base) {
      try {
        const r = await fetch(base + '/search/?s=test', { signal: AbortSignal.timeout(5000) });
        if (!r.ok) throw new Error();
        const j = await r.json();
        return !!(j && (j.data !== undefined || j.version !== undefined || Array.isArray(j)));
      } catch { return false; }
    }

    async function findWorkingApi() {
      if (manualApiOverride) return true;
      apiDot.className = 'api-dot trying';
      for (const base of API_INSTANCES) {
        const short = base.replace('https://', '');
        apiNameEl.textContent = 'trying ' + short + '…';
        const ok = await testInstance(base);
        apiStatuses[base] = ok;
        if (ok) {
          activeApi = base;
          activeStream = STREAM_INSTANCES.includes(base) ? base : STREAM_INSTANCES[0];
          apiDot.className = 'api-dot ok';
          apiNameEl.textContent = short;
          toast('connected: ' + short, 'success');
          return true;
        }
        toast(short + ' failed, trying next…', 'warn', 2000);
      }
      apiDot.className = 'api-dot fail';
      apiNameEl.textContent = 'all instances failed';
      toast('every single API instance is down. spectacular.', 'error', 6000);
      return false;
    }

    async function apiGet(path) {
      if (!activeApi) { const ok = await findWorkingApi(); if (!ok) throw new Error('no working API'); }
      const order = manualApiOverride ? [manualApiOverride] : [activeApi, ...API_INSTANCES.filter(x => x !== activeApi)];
      for (const base of order) {
        try {
          const r = await fetch(base + path, { signal: AbortSignal.timeout(8000) });
          if (!r.ok) throw new Error();
          const j = await r.json();
          if (base !== activeApi && !manualApiOverride) {
            activeApi = base; apiDot.className = 'api-dot ok';
            apiNameEl.textContent = base.replace('https://', '');
            toast('auto-switched to: ' + base.replace('https://', ''), 'warn');
          }
          return j;
        } catch (e) {
          if (base === activeApi) { apiDot.className = 'api-dot trying'; }
        }
      }
      apiDot.className = 'api-dot fail';
      throw new Error('all instances failed');
    }

    function renderApiList() {
      const list = document.getElementById('apiList');
      list.innerHTML = '';
      API_INSTANCES.forEach(url => {
        const short = url.replace('https://', '');
        const status = apiStatuses[url];
        const isSelected = (manualApiOverride || activeApi) === url;
        const item = document.createElement('div');
        item.className = 'api-option' + (isSelected ? ' selected' : '');
        item.innerHTML = `<div class="api-option-dot"></div><div class="api-option-name">${short}</div><div class="api-option-status">${status === true ? '✓ ok' : status === false ? '✗ fail' : '…'}</div>`;
        item.addEventListener('click', () => {
          manualApiOverride = url; activeApi = url;
          activeStream = STREAM_INSTANCES.includes(url) ? url : STREAM_INSTANCES[0];
          apiDot.className = 'api-dot ok'; apiNameEl.textContent = short;
          renderApiList(); toast('switched to: ' + short, 'warn');
        });
        list.appendChild(item);
      });
    }

    async function testAllInstances() {
      const btn = document.getElementById('retestApiBtn');
      btn.textContent = '↻ testing…'; btn.disabled = true;
      toast('testing all instances…', '', 2000);
      await Promise.all(API_INSTANCES.map(async url => {
        apiStatuses[url] = null; renderApiList();
        apiStatuses[url] = await testInstance(url);
        renderApiList();
      }));
      btn.textContent = '↻ test all instances'; btn.disabled = false;
      toast('done testing.', 'success');
    }
    document.getElementById('retestApiBtn').addEventListener('click', testAllInstances);

    // ══════════════════════════════════════════════════════
    //  HELPERS
    // ══════════════════════════════════════════════════════
    function coverUrl(uuid) {
      if (!uuid) return '';
      return 'https://resources.tidal.com/images/' + uuid.replace(/-/g, '/') + '/origin.jpg';
    }
    function fmtTime(s) {
      if (!s || isNaN(s)) return '0:00';
      const m = Math.floor(s / 60), sec = Math.floor(s % 60);
      return m + ':' + sec.toString().padStart(2, '0');
    }
    function artistName(t) { return t.artist?.name || t.artists?.[0]?.name || '—'; }
    function isExplicit(t) { return !!(t.explicit || t.contentType === 'EXPLICIT'); }

    function makeCoverSlot(coverUuid, size = 'md') {
      const isSmall = size === 'sm';
      const cls = isSmall ? 'q-thumb-slot' : 'thumb-slot';
      const url = coverUrl(coverUuid);
      return `<div class="${cls}">
    ${url ? `<img src="${url}" alt="" loading="lazy">` : ''}
    <div class="cover-placeholder">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><line x1="3" y1="21" x2="9" y2="13"/><path d="M9 13l4-4 4 8"/><line x1="15" y1="11" x2="21" y2="3"/></svg>
    </div>
  </div>`;
    }

    function explicitBadge() {
      return `<span class="explicit-badge">E</span>`;
    }

    // toast
    function toast(msg, type = '', dur = 3500) {
      const wrap = document.getElementById('toastWrap');
      const el = document.createElement('div');
      el.className = 'toast' + (type ? ' ' + type : '');
      el.textContent = msg;
      wrap.appendChild(el);
      requestAnimationFrame(() => el.classList.add('show'));
      setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 350); }, dur);
    }

    // Discord RPC Helper
    async function updateRPC() {
      if (!queue || !queue.length || queueIdx < 0) return;

      const track = queue[queueIdx];
      if (!track) return;

      const title = track.title || 'Unknown Track';
      const artist = artistName(track);
      const album = track.album?.title || 'Unknown Album';

      // Try to pass raw URL to Discord. If it doesn't work out of the box with the RPC library, 
      // the user will need to configure asset keys, but the instruction asks to use raw URLs.
      const albumArtUrl = coverUrl(track.album?.cover);

      const currentTime = audio.currentTime || 0;
      const duration = audio.duration || 0;

      try {
        await fetch('http://localhost:6969/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title,
            artist,
            album,
            albumArtUrl,
            currentTime,
            duration,
            isPlaying: isPlaying
          })
        });
      } catch (err) {
        // Fail silently if companion server isn't running
      }
    }

    // ══════════════════════════════════════════════════════
    //  STATE
    // ══════════════════════════════════════════════════════
    let queue = [], queueIdx = -1, isPlaying = false, isShuffle = false;
    let isAutoplay = false, isCrossfade = false;
    let tasteProfile = [];
    let playlists = { "Favorited Songs": [] };

    function saveSettings() {
      const s = {
        theme: currentTheme,
        eq: eqValues,
        eqPreset: activeEqPreset,
        vol: document.getElementById('volSlider').value,
        speed: document.getElementById('speedSlider') ? document.getElementById('speedSlider').value : 1,
        hideExplicit: hideExplicitWithCovers,
        antiEpilepsy: antiEpilepsyMode,
        coversHidden: coversHidden,
        isShuffle: isShuffle,
        isAutoplay: isAutoplay,
        isCrossfade: isCrossfade,
        crossfadeDuration: document.getElementById('cfSlider').value,
        tasteProfile: tasteProfile,
        playlists: playlists
      };
      localStorage.setItem('audia_settings', JSON.stringify(s));
    }

    // ══════════════════════════════════════════════════════
    //  SEARCH
    // ══════════════════════════════════════════════════════
    async function doSearch(query, targetContainer, labelEl) {
      query = query.trim();
      if (!query) return;
      targetContainer.innerHTML = '<div class="list-empty"><span class="spin"></span> searching…</div>';
      if (labelEl) labelEl.textContent = 'results';
      try {
        const data = await apiGet('/search/?s=' + encodeURIComponent(query));
        const items = data?.data?.items || data?.items || [];
        if (labelEl) labelEl.textContent = 'results (' + items.length + ')';
        if (!items.length) { targetContainer.innerHTML = '<div class="list-empty">no results.</div>'; return; }
        targetContainer.innerHTML = '';
        items.forEach(t => targetContainer.appendChild(buildTrackRow(t)));
      } catch (e) {
        targetContainer.innerHTML = '<div class="list-empty" style="color:var(--danger)">search failed: ' + e.message + '</div>';
      }
    }

    function buildTrackRow(t) {
      const row = document.createElement('div');
      row.className = 'track-item';
      const explicit = isExplicit(t);
      row.innerHTML =
        makeCoverSlot(t.album?.cover) +
        `<div class="track-meta">
      <div class="track-title">${t.title || '—'}${explicit ? explicitBadge() : ''}</div>
      <div class="track-artist">${artistName(t)}</div>
    </div>
    <div class="track-dur">${fmtTime(t.duration)}</div>
    <button class="add-btn">+queue</button>`;
      row.querySelector('.add-btn').addEventListener('click', e => { e.stopPropagation(); addToQueue(t); });
      row.addEventListener('click', () => { addToQueue(t); playFromQueue(queue.length - 1); });
      return row;
    }

    // Playlists UI Logic
    document.getElementById('showPlaylistsBtn').addEventListener('click', () => {
      document.getElementById('playlistsWrap').style.display = 'flex';
      document.getElementById('idleMsg').style.display = 'none';
      document.getElementById('nowPlayingWrap').classList.remove('visible');
      renderPlaylists();
    });

    // Playlists UI Logic
    document.getElementById('showPlaylistsBtn').addEventListener('click', () => {
      document.getElementById('playlistsWrap').classList.add('active');
      renderPlaylists();
    });

    document.getElementById('closePlaylistsBtn').addEventListener('click', hidePlaylists);
    document.getElementById('playlistsWrap').addEventListener('click', (e) => {
      if (e.target.id === 'playlistsWrap') hidePlaylists();
    });

    function hidePlaylists() {
      document.getElementById('playlistsWrap').classList.remove('active');
    }

    window.createPlaylist = function () {
      const name = prompt('Enter a name for the new playlist:');
      if (name && !playlists[name]) {
        playlists[name] = [];
        saveSettings();
        renderPlaylists();
      }
    };

    window.renamePlaylist = function (oldName) {
      const newName = prompt('Enter new name for playlist:', oldName);
      if (newName && newName !== oldName && !playlists[newName]) {
        playlists[newName] = playlists[oldName];
        delete playlists[oldName];
        saveSettings();
        renderPlaylists();
      }
    };

    window.deletePlaylist = function (name) {
      if (confirm(`Delete playlist "${name}"?`)) {
        delete playlists[name];
        saveSettings();
        renderPlaylists();
      }
    };

    function renderPlaylists() {
      const container = document.getElementById('playlistsContent');
      container.innerHTML = '';
      Object.keys(playlists).forEach(name => {
        const pl = playlists[name];
        const section = document.createElement('div');
        section.style.background = 'var(--surface)';
        section.style.border = '1px solid var(--border)';
        section.style.borderRadius = '8px';
        section.style.padding = '16px';

        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';

        let actHtml = '';
        if (name !== 'Favorited Songs') {
          actHtml = `<div style="display:flex; gap:8px;">
            <button class="icon-btn" onclick="renamePlaylist('${name.replace(/'/g, "\\'")}')" style="padding:4px;width:24px;height:24px;" title="Rename"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></button>
            <button class="icon-btn" onclick="deletePlaylist('${name.replace(/'/g, "\\'")}')" style="padding:4px;color:#ff4444;width:24px;height:24px;" title="Delete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M3 6h18M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6M10 11v6M14 11v6M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg></button>
          </div>`;
        }

        header.innerHTML = `<h3 style="font-size:16px; color:var(--accent); margin-bottom:12px; font-family:'DM Mono', monospace; font-weight:700;">${name} <span style="font-size:11px; color:var(--muted);">${pl.length} tracks</span></h3>${actHtml}`;
        section.appendChild(header);

        if (pl.length === 0) {
          section.innerHTML += `<div class="list-empty" style="padding:10px;">no tracks yet.</div>`;
        } else {
          const list = document.createElement('div');
          list.style.display = 'flex'; list.style.flexDirection = 'column'; list.style.gap = '4px';
          // reverse to show newest first
          [...pl].reverse().forEach(t => {
            const row = buildTrackRow(t);
            const btn = row.querySelector('.add-btn');
            btn.textContent = '✕ remove';
            btn.style.color = '#ff4444';
            btn.style.borderColor = 'transparent';
            btn.style.opacity = '0.5';
            btn.onmouseenter = () => btn.style.opacity = '1';
            btn.onmouseleave = () => btn.style.opacity = '0.5';
            btn.onclick = (e) => {
              e.stopPropagation();
              playlists[name] = playlists[name].filter(x => x.id !== t.id);
              saveSettings();
              renderPlaylists();
            };
            list.appendChild(row);
          });
          section.appendChild(list);
        }
        container.appendChild(section);
      });
    }

    // desktop search
    document.getElementById('searchBtn').addEventListener('click', () => {
      const container = document.getElementById('searchResults');
      const label = document.getElementById('resultsLabel');
      doSearch(document.getElementById('searchInput').value, container, label);
    });
    document.getElementById('searchInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        const container = document.getElementById('searchResults');
        const label = document.getElementById('resultsLabel');
        doSearch(e.target.value, container, label);
      }
    });
    // mobile search
    document.getElementById('mSearchBtn').addEventListener('click', () => {
      doSearch(document.getElementById('mSearchInput').value, document.getElementById('mSearchResults'), null);
    });
    document.getElementById('mSearchInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') doSearch(e.target.value, document.getElementById('mSearchResults'), null);
    });

    // ══════════════════════════════════════════════════════
    //  QUEUE
    // ══════════════════════════════════════════════════════
    function addToQueue(track) {
      queue.push(track);
      renderQueue();
      toast('queued: ' + track.title, '', 1800);
      if (queue.length === 1 && !isPlaying) playFromQueue(0);
    }

    function renderQueue() {
      const desktopEl = document.getElementById('queueList');
      const mobileEl = document.getElementById('mQueueList');
      const countEl = document.getElementById('queueCount');
      if (countEl) countEl.textContent = queue.length + ' track' + (queue.length !== 1 ? 's' : '');

      function buildQueueHTML(el) {
        if (!queue.length) {
          el.innerHTML = '<div class="list-empty">queue is empty.<br><span style="opacity:0.5">add tracks from search.</span></div>';
          return;
        }
        el.innerHTML = '';
        queue.forEach((t, i) => {
          const item = document.createElement('div');
          item.className = 'queue-item' + (i === queueIdx ? ' current' : '');
          const explicit = isExplicit(t);
          item.innerHTML =
            `<span class="q-idx">${i + 1}</span>` +
            makeCoverSlot(t.album?.cover, 'sm') +
            `<div class="q-meta">
          <div class="q-title">${t.title || '—'}${explicit ? explicitBadge() : ''}</div>
          <div class="q-artist">${artistName(t)}</div>
        </div>
        <button class="q-remove">✕</button>`;
          item.querySelector('.q-remove').addEventListener('click', e => {
            e.stopPropagation();
            queue.splice(i, 1);
            if (queueIdx > i) queueIdx--;
            else if (queueIdx === i) queueIdx = Math.min(queueIdx, queue.length - 1);
            renderQueue();
          });
          item.addEventListener('click', () => playFromQueue(i));
          el.appendChild(item);
        });
      }
      if (desktopEl) buildQueueHTML(desktopEl);
      if (mobileEl) buildQueueHTML(mobileEl);
    }

    // ══════════════════════════════════════════════════════
    //  PLAYBACK
    // ══════════════════════════════════════════════════════
    async function playFromQueue(idx) {
      if (idx < 0 || idx >= queue.length) return;
      queueIdx = idx;
      renderQueue();
      updateNowPlayingUI(queue[idx]);
      await loadAndPlay(queue[idx]);
    }

    async function loadAndPlay(track) {
      // init audio context on first play (browser policy)
      initAudioContext();
      if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

      const streamBases = [...new Set([activeStream, activeApi, ...STREAM_INSTANCES, ...API_INSTANCES].filter(Boolean))];
      const qualities = ['LOSSLESS', 'HIGH', 'LOW'];
      let streamUrl = null, usedQuality = null;

      for (const base of streamBases) {
        for (const q of qualities) {
          try {
            const r = await fetch(base + '/track/?id=' + track.id + '&quality=' + q, { signal: AbortSignal.timeout(8000) });
            if (!r.ok) throw new Error();
            const j = await r.json();
            const m64 = j?.data?.manifest || j?.manifest;
            const mime = j?.data?.manifestMimeType || j?.manifestMimeType;
            if (!m64) throw new Error('no manifest');
            if (mime === 'application/vnd.tidal.bts') {
              const url = JSON.parse(atob(m64))?.urls?.[0];
              if (url) { streamUrl = url; usedQuality = q; activeStream = base; break; }
            } else if (mime === 'application/dash+xml') {
              const match = atob(m64).match(/initialization="([^"]+)"/);
              if (match) { streamUrl = match[1]; usedQuality = q + ' (hi-res)'; activeStream = base; break; }
            }
          } catch { /* try next */ }
        }
        if (streamUrl) break;
      }

      if (!streamUrl) { toast('could not get stream URL. RIP.', 'error', 5000); return; }

      audio.pause();
      audio.src = streamUrl;
      audio.volume = parseFloat(document.getElementById('volSlider').value);
      try {
        await audio.play();
        setPlayState(true);
        updateRPC();
        const badge = document.getElementById('qualityBadge');
        // Force LOSSLESS
        badge.textContent = '◆ LOSSLESS';
      } catch (e) {
        if (e.name !== 'AbortError' && !e.message.includes('interrupted')) {
          toast('playback error: ' + e.message, 'error');
        }
        if (audio.error) setPlayState(false);
      }
    }

    function updateNowPlayingUI(track) {
      const artist = artistName(track);
      const cover = coverUrl(track.album?.cover);

      document.getElementById('idleMsg').style.display = 'none';
      document.getElementById('nowPlayingWrap').classList.add('visible');
      document.getElementById('npTitle').textContent = track.title || '—';
      document.getElementById('npArtist').textContent = artist;
      document.getElementById('npAlbum').textContent = track.album?.title || '—';
      document.getElementById('fullscreenTitle').textContent = track.title || '—';
      document.getElementById('fullscreenArtist').textContent = artist;
      document.getElementById('fullscreenAlbum').textContent = track.album?.title || '—';
      document.getElementById('barTitle').textContent = track.title || '—';
      document.getElementById('barArtist').textContent = artist;
      document.title = (track.title || '—') + ' — audia';

      if (cover) {
        document.getElementById('mainArt').src = cover;
        document.getElementById('bgBlur').style.backgroundImage = 'url(' + cover + ')';
        document.getElementById('fullscreenArt').src = cover;
        document.getElementById('fullscreenBg').style.backgroundImage = 'url(' + cover + ')';
        const bt = document.getElementById('barThumb');
        bt.src = cover; bt.style.display = 'block';
      }

      // Update OS MediaSession
      if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title: track.title || 'Unknown Track',
          artist: artist,
          album: track.album?.title || 'Unknown Album',
          artwork: [
            { src: cover || '', sizes: '512x512', type: 'image/jpeg' }
          ]
        });
      }

      updateRPC();
    }

    function setPlayState(playing) {
      isPlaying = playing;
      ['playIcon', 'fsPlayIcon'].forEach(id => document.getElementById(id).style.display = playing ? 'none' : 'block');
      ['pauseIcon', 'fsPauseIcon'].forEach(id => document.getElementById(id).style.display = playing ? 'block' : 'none');
      updateRPC();
    }

    // ══════════════════════════════════════════════════════
    //  AUDIO EVENTS
    // ══════════════════════════════════════════════════════
    // Autoplay Algorithm
    async function handleAutoplay() {
      if (!isAutoplay) return;
      const remaining = queue.length - 1 - queueIdx;
      if (remaining <= 19) {
        toast('autoplay working...', '', 2000);
        try {
          const t = queue[queueIdx] || tasteProfile[Math.floor(Math.random() * tasteProfile.length)];
          const qStr = t ? artistName(t) : "top";
          const data = await apiGet('/search/?s=' + encodeURIComponent(qStr));
          const items = data?.data?.items || data?.items || [];
          let added = 0;
          items.forEach(item => {
            if (!queue.find(x => x.id === item.id)) {
              queue.push(item);
              added++;
            }
          });
          if (added > 0) renderQueue();
        } catch (e) { console.warn("autoplay err", e); }
      }
    }

    let crossfadeFadeOut = null;
    audio.addEventListener('timeupdate', () => {
      if (!audio.duration) return;

      // Crossfade logic (pseudo-crossfade: fade out and skip early)
      const cfVal = parseFloat(document.getElementById('cfSlider').value) || 3;
      if (isCrossfade && audio.duration - audio.currentTime <= cfVal && queueIdx < queue.length - 1 && !isShuffle) {
        if (!crossfadeFadeOut) {
          const originalVol = parseFloat(document.getElementById('volSlider').value) || 1;
          crossfadeFadeOut = setInterval(() => {
            if (audio.volume > 0.05) audio.volume -= 0.05;
          }, 150);
          setTimeout(() => {
            clearInterval(crossfadeFadeOut);
            crossfadeFadeOut = null;
            audio.volume = originalVol;
            playFromQueue(queueIdx + 1);
            handleAutoplay();
          }, 3000);
        }
      }

      const pct = (audio.currentTime / audio.duration) * 100;
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('fsProgressFill').style.width = pct + '%';
      document.getElementById('currentTime').textContent = fmtTime(audio.currentTime);
      document.getElementById('totalTime').textContent = fmtTime(audio.duration);
      document.getElementById('fsCurrentTime').textContent = fmtTime(audio.currentTime);
      document.getElementById('fsTotalTime').textContent = fmtTime(audio.duration);

      // Update RPC every ~15 seconds while playing
      if (Math.floor(audio.currentTime) !== 0 && Math.floor(audio.currentTime) % 15 === 0 && !audio.paused) {
        // Prevent calling `updateRPC` multiple times per exact second frame
        if (window._lastRpcUpdate !== Math.floor(audio.currentTime)) {
          window._lastRpcUpdate = Math.floor(audio.currentTime);
          updateRPC();
        }
      }
    });
    audio.addEventListener('ended', () => {
      setPlayState(false);
      handleAutoplay().then(() => {
        if (isShuffle) playFromQueue(Math.floor(Math.random() * queue.length));
        else if (queueIdx < queue.length - 1) playFromQueue(queueIdx + 1);
        else toast('end of queue.', '', 2500);
      });
    });
    audio.addEventListener('error', () => { toast('audio error — URL may have expired.', 'error', 5000); setPlayState(false); });

    // Taste & Favorites
    function getCurrentTrack() { return queue[queueIdx]; }
    function addTaste() {
      const t = getCurrentTrack(); if (!t) return;
      if (!tasteProfile.find(x => x.id === t.id)) {
        tasteProfile.push(t); saveSettings(); toast('added to taste profile 💖');
      } else toast('already in taste profile 💖');
    }
    function addFavorite() {
      const t = getCurrentTrack(); if (!t) return;
      if (!playlists["Favorited Songs"].find(x => x.id === t.id)) {
        playlists["Favorited Songs"].push(t); saveSettings(); toast('added to Favorited Songs');
      } else toast('already in Favorited Songs');
    }
    window.addTaste = addTaste; window.addFavorite = addFavorite;

    // ══════════════════════════════════════════════════════
    //  CONTROLS
    // ══════════════════════════════════════════════════════
    document.getElementById('playPauseBtn').addEventListener('click', () => {
      if (!queue.length) { toast('queue is empty.', '', 2000); return; }
      if (queueIdx < 0) { playFromQueue(0); return; }
      if (!audio.src || audio.src === window.location.href) { playFromQueue(queueIdx); return; }
      if (isPlaying) { audio.pause(); setPlayState(false); }
      else { audio.play(); setPlayState(true); }
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      if (!queue.length) return;
      if (isShuffle) { playFromQueue(Math.floor(Math.random() * queue.length)); return; }
      if (queueIdx < queue.length - 1) playFromQueue(queueIdx + 1);
      else toast('that is literally the last track.', '', 2000);
    });
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (audio.currentTime > 3) { audio.currentTime = 0; return; }
      if (queueIdx > 0) playFromQueue(queueIdx - 1); else audio.currentTime = 0;
    });
    document.getElementById('restartBtn').addEventListener('click', () => {
      audio.currentTime = 0;
      if (!isPlaying && queue.length && queueIdx >= 0) audio.play().then(() => setPlayState(true)).catch(() => { });
    });
    document.getElementById('shuffleBtn').addEventListener('click', () => {
      isShuffle = !isShuffle;
      const btn = document.getElementById('shuffleBtn');
      btn.style.opacity = isShuffle ? '1' : '0.3';
      btn.style.color = isShuffle ? 'var(--accent)' : '';
      toast('shuffle ' + (isShuffle ? 'on' : 'off'), '', 1500);
      saveSettings();
    });
    document.getElementById('autoplayBtn').addEventListener('click', () => {
      isAutoplay = !isAutoplay;
      const btn = document.getElementById('autoplayBtn');
      btn.style.opacity = isAutoplay ? '1' : '0.4';
      btn.style.color = isAutoplay ? 'var(--accent)' : '';
      toast('autoplay ' + (isAutoplay ? 'on' : 'off'), '', 1500);
      if (isAutoplay && isPlaying) handleAutoplay();
      saveSettings();
    });
    document.getElementById('crossfadeBtn').addEventListener('click', () => {
      isCrossfade = !isCrossfade;
      const btn = document.getElementById('crossfadeBtn');
      btn.style.opacity = isCrossfade ? '1' : '0.4';
      btn.style.color = isCrossfade ? 'var(--accent)' : '';
      const val = document.getElementById('cfSlider').value;
      toast('crossfade ' + (isCrossfade ? val + 's' : 'off'), '', 1500);
      saveSettings();
    });
    document.getElementById('cfSlider').addEventListener('input', e => {
      document.getElementById('cfVal').textContent = e.target.value + 's';
      if (!isCrossfade) {
        document.getElementById('crossfadeBtn').click();
      } else {
        saveSettings();
      }
    });
    document.getElementById('progressBar').addEventListener('click', e => {
      if (!audio.duration) return;
      const r = e.currentTarget.getBoundingClientRect();
      audio.currentTime = ((e.clientX - r.left) / r.width) * audio.duration;
    });
    document.getElementById('volSlider').addEventListener('input', e => { audio.volume = e.target.value; });

    function clearQueue() {
      audio.pause(); audio.src = '';
      queue = []; queueIdx = -1;
      setPlayState(false); renderQueue();
      if (isAutoplay) document.getElementById('autoplayBtn').click();
      document.getElementById('idleMsg').style.display = '';
      document.getElementById('nowPlayingWrap').classList.remove('visible');
      document.getElementById('qualityBadge').style.display = 'none';
      document.getElementById('barThumb').style.display = 'none';
      ['progressFill', 'fsProgressFill'].forEach(id => document.getElementById(id).style.width = '0%');
      ['currentTime', 'totalTime', 'fsCurrentTime', 'fsTotalTime'].forEach(id => document.getElementById(id).textContent = '0:00');
      document.getElementById('barTitle').textContent = '—';
      document.getElementById('barArtist').textContent = '—';
      document.title = 'audia';
    }
    document.getElementById('clearQueueBtn').addEventListener('click', clearQueue);
    document.getElementById('mClearQueueBtn').addEventListener('click', clearQueue);

    // Setup MediaSession handlers
    if ('mediaSession' in navigator) {
      navigator.mediaSession.setActionHandler('play', () => { if (!isPlaying) document.getElementById('playPauseBtn').click(); });
      navigator.mediaSession.setActionHandler('pause', () => { if (isPlaying) document.getElementById('playPauseBtn').click(); });
      navigator.mediaSession.setActionHandler('previoustrack', () => document.getElementById('prevBtn').click());
      navigator.mediaSession.setActionHandler('nexttrack', () => document.getElementById('nextBtn').click());
      try {
        navigator.mediaSession.setActionHandler('seekto', (details) => {
          if (details.fastSeek && 'fastSeek' in audio) {
            audio.fastSeek(details.seekTime);
          } else {
            audio.currentTime = details.seekTime;
          }
        });
      } catch (error) {
        // seekto not supported
      }
    }

    // ══════════════════════════════════════════════════════
    //  MOBILE TABS
    // ══════════════════════════════════════════════════════
    let mobileActiveTab = 'now';
    function switchMobileTab(tab) {
      mobileActiveTab = tab;
      ['now', 'search', 'queue'].forEach(t => {
        document.getElementById('mTab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.toggle('active', t === tab);
      });
      document.getElementById('mainArea').style.display = tab === 'now' ? '' : 'none';
      document.getElementById('mSearchPanel').classList.toggle('active', tab === 'search');
      document.getElementById('mQueuePanel').classList.toggle('active', tab === 'queue');
    }
    // make switchMobileTab global
    window.switchMobileTab = switchMobileTab;

    // ══════════════════════════════════════════════════════
    //  INIT
    // ══════════════════════════════════════════════════════
    function loadSettings() {
      try {
        const s = JSON.parse(localStorage.getItem('audia_settings') || '{}');
        if (s.theme) applyTheme(s.theme); else applyTheme('iron');
        if (s.eq) { eqValues = s.eq; renderEqBands(); }
        if (s.eqPreset) applyEqPreset(s.eqPreset);
        if (s.vol !== undefined) { document.getElementById('volSlider').value = s.vol; audio.volume = s.vol; }
        if (s.speed !== undefined && document.getElementById('speedSlider')) { document.getElementById('speedSlider').value = s.speed; audio.playbackRate = s.speed; }
        if (s.hideExplicit !== undefined) {
          hideExplicitWithCovers = s.hideExplicit;
          document.getElementById('toggleHideExplicit').checked = hideExplicitWithCovers;
        }
        if (s.antiEpilepsy !== undefined) {
          antiEpilepsyMode = s.antiEpilepsy;
          document.getElementById('toggleAntiEpilepsy').checked = antiEpilepsyMode;
        }
        if (s.coversHidden !== undefined) {
          coversHidden = s.coversHidden;
          updateCoversHiddenClass();
          document.getElementById('coverToggleBtn').classList.toggle('active', coversHidden);
        }
        if (s.isShuffle !== undefined) {
          isShuffle = s.isShuffle;
          document.getElementById('shuffleBtn').style.opacity = isShuffle ? '1' : '0.3';
          document.getElementById('shuffleBtn').style.color = isShuffle ? 'var(--accent)' : '';
        }
        if (s.isAutoplay !== undefined) {
          isAutoplay = s.isAutoplay;
          document.getElementById('autoplayBtn').style.opacity = isAutoplay ? '1' : '0.4';
          document.getElementById('autoplayBtn').style.color = isAutoplay ? 'var(--accent)' : '';
        }
        if (s.isCrossfade !== undefined) {
          isCrossfade = s.isCrossfade;
          document.getElementById('crossfadeBtn').style.opacity = isCrossfade ? '1' : '0.4';
          document.getElementById('crossfadeBtn').style.color = isCrossfade ? 'var(--accent)' : '';
        }
        if (s.crossfadeDuration !== undefined && document.getElementById('cfSlider')) {
          const val = parseFloat(s.crossfadeDuration) || 3;
          document.getElementById('cfSlider').value = val;
          document.getElementById('cfVal').textContent = val + 's';
        }
        if (s.tasteProfile) tasteProfile = s.tasteProfile;
        if (s.playlists) playlists = s.playlists;
      } catch (e) {
        applyTheme('iron'); // default fallback
      }
    }

    loadSettings();
    renderThemeSwatches();
    renderEqBands();
    renderEqPresets();
    renderApiList();
    findWorkingApi();

    // Auto-save settings when unloading
    window.addEventListener('beforeunload', saveSettings);
  </script>
</body>

</html>
